name: E2E Tests (Playwright)

on:
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      project:
        description: 'Playwright project to run'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - api
          - all

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.12"

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.project }})
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        project: ${{ github.event.inputs.project == 'all' && fromJSON('["chromium","firefox","api"]') || fromJSON(format('["{0}"]', github.event.inputs.project || 'chromium')) }}

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping:1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-e2e-${{ hashFiles('api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-e2e-
            ${{ runner.os }}-pip-

      - name: Install API dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps ${{ matrix.project != 'api' && matrix.project || 'chromium' }}

      - name: Start API server
        run: |
          cd api && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for API..."
          timeout 60 bash -c 'until curl -sf http://localhost:8000/health; do sleep 2; done'
          echo "API is ready"
        env:
          MONGODB_URI: mongodb://localhost:27017
          MONGODB_DATABASE: crawler_system_e2e
          ENV: test
          SECRET_KEY: e2e-test-secret-key-not-for-production
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key-for-e2e' }}

      - name: Start frontend dev server
        if: matrix.project != 'api'
        working-directory: frontend
        run: |
          npm run dev &
          echo "Waiting for frontend..."
          timeout 60 bash -c 'until curl -sf http://localhost:5173; do sleep 2; done'
          echo "Frontend is ready"
        env:
          VITE_API_URL: http://localhost:8000

      - name: Run E2E tests
        working-directory: frontend
        run: |
          npx playwright test \
            --config=../tests/e2e/playwright.config.ts \
            --project=${{ matrix.project }} \
            --reporter=list,html,json
        env:
          CI: true
          API_URL: http://localhost:8000
          FRONTEND_URL: http://localhost:5173
          PLAYWRIGHT_JSON_OUTPUT_NAME: test-results/results.json

      - name: Upload Playwright report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report-${{ matrix.project }}
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 14

      - name: Upload test screenshots
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: e2e-screenshots-${{ matrix.project }}
          path: tests/e2e/test-results/**/*.png
          retention-days: 7

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    steps:
      - name: Check E2E results
        run: |
          if [ "${{ needs.e2e-tests.result }}" == "failure" ]; then
            echo "::error::E2E tests failed. Check Playwright reports for details."
            exit 1
          elif [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "::notice::All E2E tests passed successfully."
          else
            echo "::warning::E2E tests completed with status: ${{ needs.e2e-tests.result }}"
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "# E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the Playwright HTML report from the artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
