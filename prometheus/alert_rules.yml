# Prometheus Alert Rules for Crawler System
# Enterprise-grade alerting for crawl operations, API health, and infrastructure
# Metric names align with etl_* metrics exported by api/app/services/observability/prometheus.py

groups:
  # ============================================
  # Crawl Operation Alerts
  # ============================================
  - name: crawl_operations
    rules:
      - alert: CrawlFailureRateHigh
        expr: |
          (
            sum(rate(etl_pipeline_executions_total{status="failed"}[15m]))
            /
            sum(rate(etl_pipeline_executions_total[15m]))
          ) > 0.3
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Crawl failure rate exceeds 30%"
          description: "Crawl failure rate is {{ $value | humanizePercentage }} over the last 15 minutes."

      - alert: CrawlZeroRecords
        expr: |
          etl_records_processed_total == 0
          and
          etl_pipeline_executions_total{status="success"} > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Crawler returning zero records"
          description: "A crawler completed successfully but returned 0 records for 10+ minutes."

      - alert: CrawlDurationExceeded
        expr: histogram_quantile(0.95, sum(rate(etl_pipeline_execution_duration_seconds_bucket[15m])) by (le)) > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Crawl duration p95 exceeds 5 minutes"
          description: "95th percentile crawl duration is {{ $value | humanizeDuration }}."

  # ============================================
  # API Health Alerts
  # ============================================
  - name: api_health
    rules:
      - alert: APIHighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, method, path)) > 2
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "API request latency p95 exceeds 2 seconds"
          description: "95th percentile latency for {{ $labels.method }} {{ $labels.path }} is {{ $value | humanizeDuration }}."

      - alert: APIHighErrorRate
        expr: |
          (
            sum(rate(http_errors_total[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "API error rate exceeds 5%"
          description: "API error rate is {{ $value | humanizePercentage }} over the last 5 minutes."

      - alert: APIDown
        expr: up{job="etl-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ETL API is down"
          description: "The API server has been unreachable for more than 1 minute."

      - alert: HealthCheckFailing
        expr: up{job="etl-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Health check endpoint failing"
          description: "The /health endpoint has been failing for more than 1 minute."

  # ============================================
  # MongoDB Alerts
  # ============================================
  - name: mongodb_health
    rules:
      - alert: MongoDBConnectionFailure
        expr: etl_mongodb_connection_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB connection lost"
          description: "MongoDB has been unreachable for more than 1 minute."

  # ============================================
  # PostgreSQL Alerts
  # ============================================
  - name: postgresql_health
    rules:
      - alert: PostgreSQLConnectionPoolExhausted
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL connection pool near exhaustion"
          description: "Database connections at {{ $value | humanizePercentage }} of max_connections."

  # ============================================
  # Infrastructure Alerts
  # ============================================
  - name: infrastructure
    rules:
      - alert: HighMemoryUsage
        expr: |
          (
            (process_resident_memory_bytes / 1024 / 1024)
            /
            (node_memory_MemTotal_bytes / 1024 / 1024)
          ) > 0.85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Process memory usage exceeds 85% of available memory."

      - alert: CriticalMemoryUsage
        expr: |
          (
            (process_resident_memory_bytes / 1024 / 1024)
            /
            (node_memory_MemTotal_bytes / 1024 / 1024)
          ) > 0.95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical memory usage detected"
          description: "Process memory usage exceeds 95% of available memory - risk of OOM."

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk space below 20%"
          description: "Available disk space is {{ $value | humanizePercentage }}."

      - alert: DiskSpaceCritical
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk space below 10% - CRITICAL"
          description: "Available disk space is {{ $value | humanizePercentage }} - immediate action required."

      - alert: PrometheusTargetDown
        expr: up == 0
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus target is down"
          description: "Target {{ $labels.job }} / {{ $labels.instance }} is unreachable."

  # ============================================
  # Self-Healing Alerts
  # ============================================
  - name: self_healing
    rules:
      - alert: SelfHealingLowSuccessRate
        expr: etl_healing_success_rate < 0.5
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "Self-healing success rate below 50%"
          description: "Healing success rate is {{ $value | humanizePercentage }} over the last 15 minutes."

      - alert: ErrorRateRequiresIntervention
        expr: |
          (
            sum(rate(etl_pipeline_executions_total{status="failed"}[30m]))
            /
            sum(rate(etl_pipeline_executions_total[30m]))
          ) > 0.5
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "Error rate exceeds 50% - manual intervention needed"
          description: "Sustained high error rate of {{ $value | humanizePercentage }} despite self-healing."

      - alert: SystemHealthCritical
        expr: etl_system_health_score < 0.5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "System health score critically low"
          description: "System health score is {{ $value | humanizePercentage }}."
